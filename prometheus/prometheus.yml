# ./prometheus/prometheus.yml

global:
  scrape_interval: 15s # By default, scrape every 15 seconds.

scrape_configs:
  # Scrape Prometheus itself
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090'] # Prometheus is running on localhost *within its own pod*

  # Scrape Node Exporter (using the Kubernetes Service we will create)
  - job_name: 'node-exporter'
    kubernetes_sd_configs:
      - role: endpoints
    relabel_configs:
      - source_labels: [__meta_kubernetes_service_name]
        action: keep
        regex: 'node-exporter' # This must match the name of the Service in Step 4
      - source_labels: [__meta_kubernetes_endpoint_port_name]
        action: keep
        regex: 'metrics' # We will name the port 'metrics' in the Service

  # Scrape your Spring Boot backend
  - job_name: 'car-service-backend'
    metrics_path: '/actuator/prometheus'
    kubernetes_sd_configs:
      - role: endpoints
    relabel_configs:
      - source_labels: [__meta_kubernetes_service_name]
        action: keep
        regex: 'car-service-backend-service'
      - source_labels: [__meta_kubernetes_endpoint_port_name] # Add this block
        action: keep
        regex: 'http'